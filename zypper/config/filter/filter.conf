#
# zypper.log
#


filter {

  # empty
  if ([message] == "") { drop {} }

  if ([type] == "zypper") {
    # zypper
    grok {
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zypper] main.cc(main):74 ===== Hi, me zypper 1.13.37
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zypper] main.cc(main):75 ===== 'zypper' 'ref' =====
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zconfig] ZConfig.cc(_autodetectSystemArchitecture):73 Uname architecture is 'x86_64'
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zconfig] ZConfig.cc(_autodetectTextLocale):202 Found LANG=en_US.UTF-8
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zconfig] ZConfig.cc(_autodetectTextLocale):209 Default text locale is 'en_US'
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zconfig] ZConfig.cc(Impl):341 libzypp: 16.17.3
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zypp] IniParser.cc(parse):84 Start parsing /etc/zypp/zypp.conf[g___]
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [zypp] IniParser.cc(parse):138 Done parsing /etc/zypp/zypp.conf[_eF_]
      # 2017-11-08 18:57:23 <1> x220.kkaempf(29653) [Progress++] ProgressData.cc(report):88 {#1|/etc/zypp/zypp.conf}END
      patterns_dir => [ "." ]
      patterns_files_glob => "*.pattern"
      match => {
        "message" => "%{ZYPPER}"
      }
    }
    date {
      # http://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
      locale => "en"
    }
  }
  elseif ([type] == "history") {
    grok {
      # 2017-10-11 09:49:33|command|root@x220.kkaempf|'zypper' 'dup' '--no-allow-vendor-change'|
      # 2017-10-11 09:49:33|install|breeze5-cursors|5.11.0-1.1|noarch||oss|302bbbec69179888ed639bcf7dda3aceabdd1aab|
      # 2017-10-11 09:49:34|install|breeze5-wallpapers|5.11.0-1.1|noarch||oss|a62c6d8201667395a98cd65c96fcb296cdbc8cf6|
      # 2017-10-11 10:16:01|radd   |mumble|https://download.opensuse.org/repositories/home:/darix:/playground/openSUSE_Tumbleweed|      
      patterns_dir => [ "." ]
      patterns_files_glob => "*.pattern"
      match => {
        "message" => "%{HISTORY}"
      }
    }
    date {
      # http://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
      locale => "en"
    }
  }
  else {
    grok {
      match => { "message" => ".*" }
    }
    mutate {
      add_tag => [ "_grokparsefailure" ]
    }
  }

  if ("elasticsupport" in [tags]) {
    mutate {
      # host and port are from the elasticsupport system and thus useless
      # timestamp was converted to @timestamp
      remove_field => ["host", "port", "timestamp"]
    }
  }

  if ("beats_input_codec_plain_applied" in [tags]) {
    mutate {
      remove_field => ["source", "beat"]
    }
  }

  # coming from error.log
  if ([traceback]) {
    mutate {
      add_tag => ["traceback"]
    }
  }
}
